
# Cardputer ADV "Rad10" 仕様書 (v2.0)

## 1. 概要

Cardputer ADVを、電源を入れるだけで世界中のどこかのラジオ放送に接続する「ハードボイルド受信機」にする。ユーザは能動的な選局ができず、偶然性（The Chaos）のみが新しい音楽や言語との出会いをもたらす。ADV版ではヘッドフォン出力に対応し、IMU（加速度センサ）を用いた物理的なインタラクションを導入する。

## 2. ハードウェア構成

* **デバイス:** M5Stack Cardputer ADV (M5StampS3A / ESP32-S3)
* **オーディオ出力 (I2S):**
* **DAC/Codec:** ES8311 (高音質出力・ハードウェアボリューム制御)
* **Amp:** NS4150B (スピーカー出力用)
* **Output:** 内蔵スピーカー / 3.5mmヘッドフォンジャック（排他利用）

* **入力:** 内蔵キーボード、6軸IMU (BMI270)

## 3. 機能仕様

### A. 電源・Wi-Fi・システム管理

1. **起動フロー:**

* 不揮発性メモリからWi-Fi設定を読み込み接続。
* 未設定時は「Wi-Fi設定モード」へ。
* **ヘッドフォン検出:** ES8311のレジスタ、またはGPIO検知により、起動時にヘッドフォン接続有無を判定し、出力経路（スピーカー/HP）を自動設定する。

1. **バッテリー管理 (ADV強化機能):**

* 1750mAhの大容量バッテリーを活かすため、画面隅にバッテリー残量をアイコン表示する。
* 電圧低下時は画面を暗くし、警告を表示したのちDeep Sleepへ移行。

#### B. 選局ロジック (The Chaos Engine v2)

1. **データソース:** Radio Browser API
2. **検索クエリ（拡張）:**

* `codec`: MP3, AAC, AAC+ (ESP32-S3の処理能力を活かし対応フォーマットを拡大)
* `order`: random
* `limit`: 1

1. **フィルタ:** なし（完全ランダム）

#### C. 再生・オーディオ挙動

1. **出力経路の自動切替:**

* **ヘッドフォン抜去時:** 内蔵スピーカーから再生（モノラルミックス）。
* **ヘッドフォン挿入時:** 即座にスピーカーをミュートし、ヘッドフォンへ出力（ステレオ対応可能な局はステレオ再生）。

1. **ボリューム制御 (New):**

* 「選局」はできないが、「音量」は制御可能とする。
* **キー操作:** `←` `→` キー、または `Fn` + `Up/Down` でES8311のハードウェアボリュームを調整。

1. **エラーハンドリング:**

* 再生失敗・切断時は、ノイズ音（ホワイトノイズのバッファ再生）を0.5秒挟み、自動で次の局を抽選する。

### D. ユーザーインターフェース (UI & UX)

1. **画面表示 (Cyber-Radio Style):**

* **中央:** 国名 (例: `>> BRAZIL <<`) と ビットレート (例: `128kbps`)。
* **背景/下部:** 再生中のオーディオ波形、またはFFTスペクトラムアナライザを表示（視覚的なフィードバック）。
* **ステータスバー:** Wi-Fi強度、バッテリー残量、ヘッドフォンアイコン（接続時）。

1. **操作制限と物理インタラクション (Hard-boiled Mode):**

* **選局ボタン:** 実装しない。
* **局を変える方法 (Chaos Trigger):**

1. **電源再投入:** 物理スイッチのOFF/ON。
2. **シェイク (IMU活用):** 本体を強く「振る」動作を検知 (BMI270) した場合、チューニング中のノイズエフェクトと共に「再抽選」を行う。（物理スイッチの摩耗を防ぐための救済措置だが、意図的な強いアクションが必要）

## 4. 開発要件・ライブラリ

* **開発環境:** PlatformIO (Arduino framework)
* **推奨ライブラリ:**
* `M5Unified` / `M5Cardputer`: デバイス制御、ディスプレイ描画。
* `ESP8266Audio`: ストリーミング再生、MP3/AACデコード。
* `ES8311`: コーデック制御（ボリューム、ミュート、DAC設定）。
* `ArduinoJson`: APIレスポンス解析。
