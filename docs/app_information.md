# Cardputer Adv "Rad10" 仕様書 (v2.1)

## 1. 概要

Cardputer Adv を、電源を入れるだけで世界中のどこかのラジオ放送に接続する「ハードボイルド受信機」にする。ユーザは能動的な選局ができず、偶然性（The Chaos）のみが新しい音楽や言語との出会いをもたらす。受信した楽曲情報は自動的にSDカードにログとして記録される。

## 2. ハードウェア構成

* **デバイス:** M5Stack Cardputer Adv (M5StampS3)
* **オーディオ出力 (I2S):**
  * **DAC/Codec:** ES8311 (I2C制御・ハードウェアボリューム)
  * **Amp:** NS4150B (スピーカー出力用・GPIO46で電源制御)
  * **Output:** 内蔵スピーカー
* **入力:** 内蔵キーボード
* **ストレージ:** microSDカード (ログ保存用)

## 3. 機能仕様

### A. 電源・Wi-Fi・システム管理

1. **起動フロー:**
    * 不揮発性メモリ (Preferences) からWi-Fi設定を読み込み接続。
    * 未設定時、または接続失敗時は「Wi-Fi設定モード」へ移行し、キーボードからSSID/PASSを入力可能。
    * **アンプ制御:** ポップノイズを防ぐため、ストリーム受信開始直前までアンプ電源 (GPIO46) をOFFに維持する。

2. **Wi-Fi設定リセット:**
    * `Fn` + `Backspace` (Del) キーを3秒間長押しすることで、保存されたWi-Fi設定を消去し再起動する。

### B. 選局ロジック (The Chaos Engine)

1. **データソース:** Radio Browser API
2. **検索クエリ:**
    * `tag`: プリセットされた約100種類のジャンルからランダムに1つ選択
    * `order`: clickcount (人気順)
    * `reverse`: true
    * `limit`: 1
    * `offset`: 上位30件の中からランダムにオフセット
3. **フィルタ:**
    * ビットレートが 128kbps 以下の局のみを選定（安定性重視）。
    * 0kbps（配信停止中）の局はスキップ。

### C. 再生・記録

1. **再生:**
    * `ESP32-audioI2S` ライブラリを使用し、MP3/AAC等のストリームを再生。
    * 接続失敗時は自動的に再抽選を行う。

2. **ボリューム制御:**
    * **キー操作:** `,` (Down) / `.` (Up) キーで音量を0-21の範囲で調整。

3. **プレイログ記録 (Playlog):**
    * 曲名情報 (StreamTitle) が更新されるたびに、SDカード内の `/playlog.csv` に追記保存する。
    * **記録内容:** タイムスタンプ(UTC), URL, 国名, 局名, サンプリングレート, ビットレート, アーティスト名, 曲名。

### D. ユーザーインターフェース (UI & UX)

1. **画面表示:**
    * **上部:** ステータスバー（現在音量、バッテリー残量）。
    * **中央:** 国名 (例: `>> BRAZIL <<`)。
    * **下部:** オーディオスペック（サンプリングレート、ビット深度）、現在のジャンル、接続状態。
    * **フォント:** 視認性を重視したテキスト表示。

2. **操作体系:**
    * **選局ボタン:** 実装しない。
    * **局を変える方法 (Chaos Trigger):**
        1. **スキップ:** `/` キーを押下することで、即座に次の局を再抽選する。
        2. **電源再投入:** 物理スイッチのOFF/ON。

## 4. 開発要件・ライブラリ

* **開発環境:** PlatformIO (Arduino framework)
* **主要ライブラリ:**
  * `M5Cardputer`: デバイス制御、ディスプレイ描画。
  * `M5Unified`: 電源管理。
  * `ESP32-audioI2S`: ストリーミング再生。
  * `ArduinoJson`: APIレスポンス解析。
