# Rad10 実装仕様書 (v2.1)

## 1. 概要

本ドキュメントは、M5Stack Cardputer Adv を使用したインターネットラジオプレーヤー "Rad10" の実装詳細をまとめたものである。

## 2. 開発環境と構成

* **プラットフォーム:** Espressif 32 (PlatformIO)
* **ボード:** M5Stack StampS3 (`m5stack-stamps3`)
* **フレームワーク:** Arduino
* **主要ライブラリ:**
  * `M5Cardputer` (^1.1.1)
  * `M5Unified` (^0.2.11)
  * `ArduinoJson` (^7.0.0)
  * `ESP32-audioI2S` (^2.0.7)

## 3. ハードウェア設定

* **MCU:** ESP32-S3 (M5StampS3)
* **I2C設定:** SDA=8, SCL=9
* **オーディオ出力 (I2S):**
  * BCLK: 41
  * LRCK: 43
  * DOUT: 42
* **アンプ電源制御:**
  * GPIO 46: HIGHでON。起動時はLOWで初期化し、ストリーム確立後にHIGHにすることでポップノイズを防止。
* **オーディオコーデック (ES8311) 初期化:**
  * I2C(0x18)経由で直接コマンドを送信。
  * レジスタ 0x01 に 0xB5 を書き込み、MCLKをBCLKから内部生成する設定を行う。

## 4. 機能仕様

### 4.1. ネットワーク

* Wi-Fi省電力モードを無効化 (`WiFi.setSleep(false)`) し、ストリーミングの安定性を確保。
* NTPによる時刻同期を行い、ログのタイムスタンプに使用。

### 4.2. 選局ロジック

* Radio Browser API を使用し、約100種類のジャンルタグからランダムに1つを選択。
* 人気順(clickcount)でソートし、上位30件の中からランダムに1局を選択。
* ビットレートが128kbpsを超える、または0kbpsの局は自動的に除外して再抽選する。

### 4.3. ユーザーインターフェース

* **ディスプレイ:** 国名、ジャンル、音量、バッテリー残量、オーディオスペックを表示。
* **操作:**
  * `,` : 音量ダウン (0-21)
  * `.` : 音量アップ (0-21)
  * `/` : 次の局へスキップ (Chaos Trigger)
  * `Fn` + `Backspace` (3秒長押し) : Wi-Fi設定リセット

### 4.4. ログ機能

* SDカードの `/playlog.csv` に再生履歴を記録。
* 記録項目: UTC日時, ストリームURL, 国名, 局名, オーディオ形式, アーティスト名, 曲名。

## 5. 既知の制限

* **メモリ:** PSRAMは使用せず、内蔵SRAMのみでバッファリングを行う。
* **文字コード:** 日本語などのマルチバイト文字を含む局名や曲名は、フォント制限により正しく表示されない場合がある（現状は標準フォントのみ使用）。
