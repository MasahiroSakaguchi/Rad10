# Rad10 実装仕様書 (Current Implementation)

## 1. 概要
本ドキュメントは、M5Stack Cardputer ADV を使用したインターネットラジオプレーヤー "Rad10" の実装詳細をまとめたものである。

## 2. 開発環境と構成
*   **プラットフォーム:** Espressif 32 (PlatformIO)
*   **ボード:** M5Stack StampS3 (`m5stack-stamps3`)
*   **フレームワーク:** Arduino
*   **主要ライブラリ:**
    *   `M5Cardputer` (^1.1.1)
    *   `M5Unified` (^0.2.11)
    *   `ArduinoJson` (^7.0.0)
    *   `ESP32-audioI2S` (^2.0.7)

## 3. ハードウェア設定 (Cardputer ADV 特有)
*   **MCU:** ESP32-S3 (M5StampS3)
*   **I2C設定:** SDA=8, SCL=9
*   **オーディオ出力 (I2S):**
    *   BCLK: 41
    *   LRCK: 43
    *   DOUT: 42
*   **特殊ピン制御:**
    *   GPIO 46: HIGH (システム電源・アンプ電源供給用)
*   **オーディオコーデック (ES8311) 初期化:**
    *   M5Unifiedの自動認識に頼らず、I2C(0x18)経由で直接コマンドを送信。
    *   **重要:** レジスタ 0x01 に 0xB5 を書き込み、MCLKをBCLKから内部生成する設定が必須。

## 4. 機能仕様

### 4.1. ネットワーク
*   Wi-Fi省電力モードを無効化 (`WiFi.setSleep(false)`) し、ストリーミングの安定性を確保。

### 4.2. 選局ロジック
*   Radio Browser API を使用し、20種類以上のジャンルからランダムに選局。
*   人気上位30局の中からさらにランダムにオフセットを設定し、多様性を確保。

### 4.3. ユーザーインターフェース
*   **ディスプレイ:** 放送局名、音量、再生状態を表示。
*   **操作:**
    *   `,` : 音量ダウン (0-21)
    *   `.` : 音量アップ (0-21)
    *   `/` : 次の局へスキップ (Chaos Trigger)

## 5. 既知の制限
*   PSRAMは使用しない（StampS3のモデルにより非搭載、または競合の可能性があるため、安定性を優先してSRAMのみで運用）。